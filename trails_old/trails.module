<?php

// $Id$

/**
 * @file
 * Stores and displays a trail of previously visited pages.
 */

/**
 * Implements hook_init().
 *
 * Learn more about hook_init() here:
 * http://api.drupal.org/api/drupal/developer--hooks--core.php/function/hook_init/6
 * Challenge yourself!
 *  + Avoid saving duplicate sequential page listings (such as page refreshes).
 *  + Prevent history from being added if the page clicked was in the list of
 *    history.
 *  + Add time spent on page to each list item.
 *  ++ Prune history if there are more than 10 items already saved. -> Not more 
 *    than 10, but moren than trails_block_max
 *  - Save user information and only show current user's history. (we will cover
 *    this in a separate video)
 */
function trails_init() {
  $end_of_visit_time = REQUEST_TIME;

  
  // Grab the trail history from a variable
  $trail = variable_get('trails_history', array());
  
  add_time_spent($trail, $end_of_visit_time);

  if (is_page_already_visited($trail) == false) {
    // Add current page to trail.
    $trail[] = array(
      'title' => strip_tags(drupal_get_title()),
      'path' => $_GET['q'],
      'timestamp' => REQUEST_TIME,
      'time_spent' => 'Not yet measured',
    );

    //prune_history($trail);

    // Save the trail as a variable
    variable_set('trails_history', $trail);
  }
}

/**
 * Cuts off the history, until trails_block_max
 * @param type $trail
 */
function prune_history(&$trail) {
  $max_items_allowed = variable_get('trails_block_max');
  $total_items = count($trail);
  $trail = array_slice($trail, $total_items - $max_items_allowed, $total_items - 1);
}

/**
 * Find out if the new page being visited is already in the list displayed by the block    
 * @param type $trail Is the history trail
 */
function is_page_already_visited($trail) {
  $visited = false;
  $trail_reverse = array_reverse($trail);
  $number_of_items = count($trail);
  $current_page = $_GET['q'];
  for ($i = 0; $i < $number_of_items; $i++) {
    $compare_trail = $trail_reverse[$i];
    $compare_path = $compare_trail['path'];
    if ($current_page == $compare_path) {
      return true;
    }
  }
  return $visited;
}

/**
 * Adds the time spent visiting the last page
 * @param type $trail The page history
 * @param type $end_time Timestamp at change of page
 */
function add_time_spent(&$trail, $end_time) {
  end($trail);
  $key = key($trail);
  $trail[$key]['time_spent'] = $end_time - $trail[$key]['timestamp'];
}

/**
 * Implements hook_permission().
 *
 * Learn more about hook_permission here:
 * http://api.drupal.org/api/drupal/modules--system--system.api.php/function/hook_permission/7
 */
function trails_permission() {
  return array(
    'administer trails' => array(
      'title' => t('Administer Trails module'),
      'description' => t('Perform administration tasks for Trails module.'),
    ),
    'access trails blocks' => array(
      'title' => t('Access Trails blocks'),
      'description' => t('View blocks generated by the Trails module.'),
    ),
    'access trails full' => array(
      'title' => t('Access Full History page'),
      'description' => t('View the complete page visit trail.'),
    ),
    'delete all trails' => array(
      'title' => t('Delete trail'),
      'description' => t('Deletes all trail history.')
    ),
  );
}

/**
 * Implements hook_menu().
 *
 * Challenge yourself!
 *  - Add a new page that displays all history.
 */
function trails_menu() {
  // Module settings.
  $items['admin/config/trails'] = array(
    'title' => 'Trails',
    'description' => 'trails configuration',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('trails_admin_settings'),
    'access arguments' => array('administer trails'),
    'file' => 'trails.admin.inc',
    'file path' => drupal_get_path('module', 'trails'),
  );
  // Full page history
  $items['test/page/history'] = array(
    'Title' => 'Full history',
    'description' => 'full page visit history',
    'page callback' => trails_view_full_history,
    //'page arguments' => array(),
    'access arguments' => array('access trails full'),
  );
  $items['history/delete'] = array(
    'Title' => 'Delete all history',
    'description' => 'Deletes all visited pages history.',
    'page callback' => trails_delete_all_history,
    'access arguments' => array('delete all trails'),
  );
  return $items;
}

function trails_view_full_history() {
  $trail = variable_get('trails_history');
  $trail_reverse = array_reverse($trail);
  $output = '<ul>';
  foreach ($trail_reverse as $item) {
    $output .= '<li>' . $item['title'] . '</li>';
  }
  $output .= '</ul>';
  return $output;
}

function trails_delete_all_history() {
  $trail[] = array(
    'title' => strip_tags(drupal_get_title()),
    'path' => $_GET['q'],
    'timestamp' => REQUEST_TIME,
    'time_spent' => 'Not yet measured',
  );
  
  variable_set('trails_history', $trail);
}

/**
 * Implements hook_help().
 */
function trails_help($path, $arg) {
  switch ($path) {
    case 'admin/config/trails':
      return t('This settings page alows you to configure global settings for the Trails module.');

    case 'admin/help#trails':
      $output = '<p>' . t('Trails is a simple module that displays a trail of pages that were last visited.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_block_info().
 *
 * For another example of using block hook functions, see:
 * http://api.drupal.org/api/examples/block_example--block_example.module/7
 *
 * Learn more about hook_block_info() at:
 * http://api.drupal.org/api/drupal/modules--block--block.api.php/function/hook_block_info/7
 *
 * Challenge yourself!
 *  - Add another block with a link to delete all history.
 */
function trails_block_info() {
  $blocks['history'] = array(
    'info' => t('History'),
    'cache' => DRUPAL_NO_CACHE,
  );
  $blocks['history_delete'] = array(
    'info' => t('Delete history'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_block_configure().
 *
 * Learn more about hook_block_configure() here:
 * http://api.drupal.org/api/drupal/modules--block--block.api.php/function/hook_block_configure/7
 *
 * Challenge yourself!
 *  - Add a setting for the 'granularity' used in the format_interval() function you see
 *    in hook_block_view().
 */
function trails_block_configure($delta = '') {
// Get the maximum allowed value from the configuration form.
  $max_to_display = variable_get('trails_block_max', 50);

// Add a select box of numbers form 1 to $max_to_display.
  $form['trails_block_num'] = array(
    '#type' => 'select',
    '#title' => t('Number of items to show'),
    '#default_value' => variable_get('trails_block_num', '5'),
    '#options' => drupal_map_assoc(range(1, $max_to_display)),
  );
  return $form;
}

/**
 * Implements hook_block_save().
 *
 * Learn more about hook_block_save() here:
 * http://api.drupal.org/api/drupal/modules--block--block.api.php/function/hook_block_save/7
 */
function trails_block_save($delta = '', $edit = array()) {
  variable_set('trails_block_num', $edit['trails_block_num']);
}

/**
 * Implements hook_block_view().
 *
 * Generates block to display recently visited pages.
 *
 * Learn more about hook_block_configure() here:
 * http://api.drupal.org/api/drupal/modules--block--block.api.php/function/hook_block_view/7
 *
 * Challenge yourself!
 *  - Display only the last 5 items.
 *  - Move the html to a theme function (we will cover theming in a separate video).
 */
function trails_block_view($delta = '') {
  if (user_access('access trails blocks')) {
    $block = array();
    $type = $delta;
// list($type, $id) = explode('-', $delta); // This line is in video, but not necessary if we only have one block.
    switch ($delta) { // This was changed from $type to $delta after video was created.
      case 'history':
        // Create list of previous paths.
        // Grab the trail history from a variable
        $trail = variable_get('trails_history', array());

        // Flip the saved array to show newest pages first.
        $reverse_trail = array_reverse($trail);

        // Grab the number of items to display
        $num_items = variable_get('trails_block_num', '5');

        // Output the latest items as a list
        $output = ''; // Initialize variable, this was added after the video was created.

        xdebug_break();
        
        for ($i = 0; $i < $num_items; $i++) {
          /*if ($num_items > count($trail)) {
            break;
          }*/
          if ($item = $reverse_trail[$i]) {
            $time_spent = array_key_exists('time_spent', $item) ? $item['time_spent'] . ' seconds ' : ' - No record yet - ';
            $output .= '<li>'
                . l($item['title'], $item['path'])
                . ' - '
                . format_interval(REQUEST_TIME - $item['timestamp'])
                . ' '
                . t('ago')
                . ' - stayed '
                . format_interval($time_spent)
                . ' on page.'
                . '</li>';
          }
        }
        if (isset($output)) {
          $output = '
            <p>' . t('Below are the last !num pages you have visited.', array('!num' => $num_items)) . '</p>
            <ul>' . $output . '</ul>
          ';
        }

        // Prepare to return the $block variable with subject (title) and content (output).
        $block['subject'] = 'History';
        $block['content'] = $output;
        break;
      case 'history_delete':
        $block['subject'] = 'History delete';
        $block['content'] = l('Delete all history', 'history/delete');
        break;
    }

    return $block;
  }
}

/**
 * Implements hook_cron().
 *
 * See here for more information:
 * http://api.drupal.org/api/drupal/modules--system--system.api.php/function/hook_cron/7
 */
function trails_cron() {
// Get the trail array.
  $trail = variable_get('trails_history', array());

// Get the offset for array_slice, so we can save just last 5 items.
  $count_minus_5 = count($trail) - 5;

// Cut out everything but the last 5 visits.
  $short_trail = array_slice($trail, $count_minus_5);

// Save the shorter trail
  variable_set('trails_history', $short_trail);
}
